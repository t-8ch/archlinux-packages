# Maintainer: Thomas Wei√üschuh <thomas t-8ch de>
# Contributor: Sergej Pupykin <pupykin.s+arch@gmail.com>
# Contributor: Mark Coolen <mark.coolen@gmail.com>
# Contributor: Tom Newsom <Jeepster@gmx.co.uk>
# Contributor: Kevin Piche <kevin@archlinux.org>

pkgname=squid-beta
pkgver=3.3.1
pkgrel=2
pkgdesc='Full-featured Web proxy cache server, beta version'
arch=('x86_64' 'i686')
url='http://www.squid-cache.org'
depends=('openssl' 'pam' 'cron' 'perl' 'libltdl')
makedepends=('libcap')
license=('GPL')
options=('emptydirs')
provides=('squid')
conflicts=('squid')
backup=('etc/squid/squid.conf'
        'etc/squid/mime.conf'
        'etc/conf.d/squid')
install=squid.install
source=("http://www.squid-cache.org/Versions/v3/3.3/squid-$pkgver.tar.bz2"
        'squid'
        'squid.conf.d'
        'squid.pam'
        'squid.cron'
        'squid.service')

sha256sums=('8b76df48a255451fb9aa3071cba195164ba764c01742bec66f79fe70a2a0590a'
            '28983431f1776da90da422ac6fc0b0cd95fdfa6f4d3376eaec6584fb7ba68cf7'
            '92ca3ff6ed26f71f20947defef67ff397038d5402b74aeed739ea504af2b188d'
            '11fb388f8679fd6461e0de006810ea608a3686fffda16904b0ed71f412be499c'
            '6b05c266892b45bee0b2540c8863f272118ad98a64cdd9175b843312310b8f4f'
            'f853e55c93fdd55b536c7e611068845d04759b0f4366e821b93ae29437fb9495')

build() {
  cd "$srcdir/squid-$pkgver"

  # fix cache_dir, cache_dir size, and effective group.
  sed '/^DEFAULT_SWAP_DIR/ s@/cache@/cache/squid@' -i src/Makefile.in
  sed '/^#cache_dir/ s/100/256/
       /^NAME: cache_effective_group/ {n;n;s/none/proxy/}' -i src/cf.data.pre

  sed -i '1,1i#include <errno.h>' helpers/external_acl/file_userip/ext_file_userip_acl.cc

  ./configure \
    --prefix=/usr \
    --datadir=/usr/share/squid \
    --sysconfdir=/etc/squid \
    --libexecdir=/usr/lib/squid \
    --localstatedir=/var \
    --with-logdir=/var/log/squid \
    --with-pidfile=/run/squid.pid \
    --enable-auth \
    --enable-auth-basic \
    --enable-auth-ntlm \
    --enable-auth-digest \
    --enable-auth-negotiate \
    --enable-removal-policies="lru,heap" \
    --enable-storeio="aufs,ufs,diskd" \
    --enable-delay-pools \
    --enable-arp-acl \
    --enable-ssl \
    --enable-snmp \
    --enable-linux-netfilter \
    --enable-ident-lookups \
    --enable-useragent-log \
    --enable-cache-digests \
    --enable-referer-log \
    --enable-arp-acl \
    --enable-htcp \
    --enable-carp \
    --enable-epoll \
    --with-large-files \
    --enable-arp-acl \
    --with-default-user=proxy \
    --enable-async-io \
    --enable-truncate
  make
}

package() {
  cd "$srcdir"

  make -C "squid-$pkgver" DESTDIR="$pkgdir" install
  install -Dm755 "$srcdir/squid" "$pkgdir/etc/rc.d/squid"
  install -Dm755 "$srcdir/squid.cron" "$pkgdir/etc/cron.weekly/squid"
  install -Dm755 "$srcdir/squid.conf.d" "$pkgdir/etc/conf.d/squid"
  install -Dm644 "$srcdir/squid.pam" "$pkgdir/etc/pam.d/squid"
  install -Dm644 "$srcdir/squid.service" \
    "$pkgdir/usr/lib/systemd/system/squid.service"
  rm -rf "$pkgdir/run $pkgdir/var/run"
}

# vim: ts=2 sw=2 et ft=sh
